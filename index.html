<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UltraChat X - Cosmic Edition</title>
    
    <!-- Шрифты и Иконки -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-deep: #0b0c15;
            --bg-sidebar: rgba(16, 18, 27, 0.85);
            --bg-chat: rgba(22, 24, 35, 0.6);
            --bg-message-me: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-message-other: rgba(40, 43, 55, 0.8);
            
            --accent: #5865F2;
            --accent-hover: #4752C4;
            --text-main: #ffffff;
            --text-dim: #949BA4;
            
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            
            --radius-md: 12px;
            --radius-bubble: 20px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* --- ANIMATED STARS BACKGROUND --- */
        .stars-wrapper { position: fixed; inset: 0; z-index: -1; pointer-events: none; overflow: hidden; background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.8; animation: twinkle var(--duration) infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #202225; border-radius: 3px; }

        /* --- AUTH SCREEN --- */
        #auth-layer {
            position: fixed; inset: 0; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(15px);
            transition: opacity 0.4s ease;
        }
        
        .auth-card {
            width: 100%; max-width: 420px;
            padding: 40px;
            background: rgba(30, 33, 45, 0.95);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            text-align: center;
            animation: floatUp 0.5s ease-out;
        }
        @keyframes floatUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .logo-text {
            font-size: 1.8rem; font-weight: 800; margin-bottom: 10px;
            background: linear-gradient(to right, #fff, var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .input-group { position: relative; margin-bottom: 15px; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-dim); font-size: 0.9rem; }
        
        input, textarea {
            width: 100%; padding: 14px 14px 14px 40px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: white; font-size: 0.95rem;
            transition: 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.2); }

        .btn-primary {
            width: 100%; padding: 14px;
            background: var(--accent); color: white;
            border: none; border-radius: var(--radius-md);
            font-weight: 600; cursor: pointer; margin-top: 10px;
            transition: 0.2s;
        }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }

        .link-text { color: var(--accent); cursor: pointer; font-size: 0.85rem; margin-top: 15px; display: inline-block; }
        .link-text:hover { text-decoration: underline; }

        /* --- APP LAYOUT --- */
        #app-layer { display: none; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s; }
        .app-container { display: flex; height: 100%; }

        /* Sidebar */
        .sidebar {
            width: 320px; min-width: 320px;
            background: var(--bg-sidebar);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column;
            z-index: 20; transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px; display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid var(--glass-border); cursor: pointer;
        }
        .sidebar-header:hover { background: var(--glass-highlight); }
        
        .user-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        
        .nav-actions { display: flex; padding: 15px; gap: 10px; }
        .icon-btn {
            flex: 1; padding: 10px; background: rgba(255,255,255,0.05);
            border: none; border-radius: 10px; color: var(--text-dim); cursor: pointer;
            transition: 0.2s;
        }
        .icon-btn:hover { background: var(--glass-highlight); color: white; }

        .contacts-list { flex: 1; overflow-y: auto; padding: 10px; }
        .contact-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; margin-bottom: 4px;
        }
        .contact-item:hover { background: var(--glass-highlight); }
        .contact-item.active { background: rgba(88, 101, 242, 0.15); }
        
        .c-avatar-sm { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; }
        .c-info { flex: 1; min-width: 0; }
        .c-name { font-size: 0.95rem; color: #dedede; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-last { font-size: 0.75rem; color: var(--text-dim); }

        /* Main Chat */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; }
        
        .chat-topbar {
            height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(16, 18, 27, 0.5); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
        }
        .chat-title { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }

        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }

        .msg { max-width: 75%; display: flex; flex-direction: column; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1); translateY(0); } }

        .msg-content { padding: 10px 16px; border-radius: var(--radius-bubble); font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .msg-me { align-self: flex-end; align-items: flex-end; }
        .msg-me .msg-content { background: var(--bg-message-me); color: white; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; align-items: flex-start; }
        .msg-other .msg-content { background: var(--bg-message-other); color: #e0e0e0; border: 1px solid var(--glass-border); border-bottom-left-radius: 4px; }

        .msg-info { font-size: 0.7rem; color: rgba(255,255,255,0.4); margin-top: 4px; display: flex; gap: 5px; align-items: center; }
        .msg-img { max-width: 250px; border-radius: 12px; margin-top: 5px; border: 1px solid var(--glass-border); cursor: pointer; }

        /* Input Area */
        .input-zone { padding: 20px; background: rgba(16, 18, 27, 0.8); backdrop-filter: blur(10px); }
        .input-wrapper { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.07); padding: 5px 10px; border-radius: 24px; border: 1px solid var(--glass-border); }
        .input-wrapper input { border: none; background: transparent; box-shadow: none; padding: 12px; font-size: 1rem; }
        
        .action-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; color: var(--text-dim); cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .action-btn:hover { color: white; background: rgba(255,255,255,0.1); }
        .send-btn { background: var(--accent); color: white; width: 42px; height: 42px; box-shadow: 0 2px 10px rgba(88, 101, 242, 0.4); }
        .send-btn:hover { background: var(--accent-hover); transform: scale(1.05); }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; }
        .modal-box { background: #1e2124; width: 90%; max-width: 380px; padding: 25px; border-radius: 20px; border: 1px solid var(--glass-border); box-shadow: 0 20px 60px rgba(0,0,0,0.6); animation: zoomIn 0.3s ease; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-title { font-size: 1.2rem; margin-bottom: 15px; color: white; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-sec { background: transparent; color: var(--text-dim); border: none; padding: 10px 20px; cursor: pointer; font-weight: 500; }
        .btn-sec:hover { color: white; }
        
        .mobile-menu-btn { display: none; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-right: 10px; }

        @media (max-width: 768px) {
            .sidebar { position: absolute; height: 100%; transform: translateX(-110%); width: 85%; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.open { transform: translateX(0); }
            .mobile-menu-btn { display: block; }
            .chat-topbar { padding: 0 15px; }
        }
    </style>
</head>
<body>

    <!-- Анимированные Звезды -->
    <div class="stars-wrapper" id="star-field"></div>

    <!-- Auth Layer -->
    <div id="auth-layer">
        <div class="auth-card">
            <div class="logo-text"><i class="fas fa-rocket" style="margin-right: 10px; color: var(--accent);"></i>UltraChat X</div>
            <p style="color: var(--text-dim); margin-bottom: 25px; font-size: 0.9rem;">Войдите в космическое пространство</p>
            
            <!-- ФОРМА ВХОДА -->
            <div id="login-form">
                <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="login-email" placeholder="Электронная почта">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="login-password" placeholder="Пароль">
                </div>
            </div>

            <!-- ФОРМА РЕГИСТРАЦИИ -->
            <div id="register-form" style="display:none;">
                <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="reg-email" placeholder="tyaminomilimi.az.1234@gmail.com">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="reg-password" placeholder="Придумайте пароль">
                </div>
                <div class="input-group">
                    <i class="fas fa-at"></i>
                    <input type="text" id="reg-username" placeholder="Username (для поиска)">
                </div>
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="reg-nickname" placeholder="Ваш Никнейм">
                </div>
            </div>

            <button class="btn-primary" id="submit-auth" onclick="app.authenticate()">
                <span id="btn-text">Войти</span> <i class="fas fa-arrow-right" style="margin-left: 5px;"></i>
            </button>
            
            <div class="link-text" id="toggle-mode" onclick="ui.toggleAuthMode()">
                Впервые здесь? Создать аккаунт
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-layer">
        <div class="app-container">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header" onclick="ui.openModal('settings')">
                    <div style="position: relative;">
                        <img id="my-ava" src="" class="user-avatar" alt="Me">
                        <div class="status-dot" style="width: 12px; height: 12px; background: #2ecc71; border-radius: 50%; border: 2px solid #1e2124; position: absolute; bottom: 0; right: 0;"></div>
                    </div>
                    <div style="overflow: hidden;">
                        <h3 id="my-name" style="font-size: 1rem;">Загрузка...</h3>
                        <p id="my-bio" style="font-size: 0.75rem; color: var(--text-dim); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Настройки</p>
                    </div>
                    <i class="fas fa-cog" style="margin-left: auto; color: var(--text-dim);"></i>
                </div>

                <div class="nav-actions">
                    <button class="icon-btn" title="Добавить контакт" onclick="ui.openModal('contact')"><i class="fas fa-user-plus"></i></button>
                    <button class="icon-btn" title="Создать группу" onclick="ui.openModal('group')"><i class="fas fa-users"></i></button>
                    <button class="icon-btn" title="Выход" onclick="app.logout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>

                <div class="contacts-list" id="contacts-list">
                    <!-- JS populated -->
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="chat-area">
                <div class="chat-topbar">
                    <button class="mobile-menu-btn" onclick="ui.toggleSidebar()"><i class="fas fa-bars"></i></button>
                    <div class="chat-title">
                        <i class="fas fa-hashtag" style="color: var(--text-dim); font-size: 0.9rem;"></i>
                        <span id="current-chat-name">Общий Чат</span>
                    </div>
                </div>

                <div class="messages-container" id="msg-area">
                    <!-- Messages go here -->
                </div>

                <div class="input-zone">
                    <div class="input-wrapper">
                        <button class="action-btn" onclick="document.getElementById('file-input').click()">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                        <input type="file" id="file-input" hidden accept="image/*" onchange="app.uploadAndSend(this.files[0])">
                        
                        <input type="text" id="msg-input" placeholder="Написать сообщение..." autocomplete="off">
                        
                        <button class="action-btn send-btn" onclick="app.sendText()">
                            <i class="fas fa-paper-plane" style="font-size: 0.9rem; margin-left: -2px;"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="contact-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title"><i class="fas fa-user-plus"></i> Найти пользователя</h3>
            <div class="input-group">
                <i class="fas fa-search"></i>
                <input type="text" id="search-username" placeholder="Введите username (ID)">
            </div>
            <div class="modal-footer">
                <button class="btn-sec" onclick="ui.closeModals()">Отмена</button>
                <button class="btn-primary" style="width: auto;" onclick="app.addContact()">Добавить</button>
            </div>
        </div>
    </div>

    <div id="group-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title"><i class="fas fa-users"></i> Создать группу</h3>
            <div class="input-group">
                <i class="fas fa-tag"></i>
                <input type="text" id="new-group-name" placeholder="Название группы">
            </div>
            <div class="modal-footer">
                <button class="btn-sec" onclick="ui.closeModals()">Отмена</button>
                <button class="btn-primary" style="width: auto;" onclick="app.createGroup()">Создать</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Профиль</h3>
            <div style="text-align: center; margin-bottom: 15px;">
                <label style="cursor: pointer; position: relative; display: inline-block;">
                    <img id="preview-ava" src="" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--accent); object-fit: cover;">
                    <div style="position: absolute; bottom: 0; right: 0; background: var(--accent); width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                        <i class="fas fa-camera"></i>
                    </div>
                    <input type="file" hidden accept="image/*" onchange="app.updateAvatar(this.files[0])">
                </label>
            </div>
            <div class="input-group">
                <i class="fas fa-user-edit"></i>
                <input type="text" id="edit-nickname" placeholder="Никнейм">
            </div>
            <textarea id="edit-bio" rows="3" placeholder="О себе..."></textarea>
            <div class="modal-footer">
                <button class="btn-sec" onclick="ui.closeModals()">Закрыть</button>
                <button class="btn-primary" style="width: auto;" onclick="app.saveProfile()">Сохранить</button>
            </div>
        </div>
    </div>

    <script>
        // --- STARFIELD GENERATOR ---
        (function generateStars() {
            const wrapper = document.getElementById('star-field');
            const count = 100;
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const xy = Math.random() * 100;
                const duration = Math.random() * 3 + 2;
                const size = Math.random() * 2 + 1;
                
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.animationDuration = `${duration}s`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                wrapper.appendChild(star);
            }
        })();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, set, get, child, update, query, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCBxWoOMQpBPrTMiy-F-E0w4JC7At8LNRc",
            authDomain: "chatweb2-fa26a.firebaseapp.com",
            databaseURL: "https://chatweb2-fa26a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chatweb2-fa26a",
            storageBucket: "chatweb2-fa26a.firebasestorage.app",
            messagingSenderId: "474719270718",
            appId: "1:474719270718:web:d4ed90496766427dbd9e6f"
        };

        const appInit = initializeApp(firebaseConfig);
        const db = getDatabase(appInit);
        const auth = getAuth(appInit);
        
        let currentUser = null;
        let userProfile = null;
        let isRegister = false;
        let currentChatId = 'global'; 

        // --- UI LOGIC ---
        const ui = {
            toggleSidebar: () => document.getElementById('sidebar').classList.toggle('open'),
            
            openModal: (id) => {
                document.getElementById(id + '-modal').style.display = 'flex';
                if(id === 'settings' && userProfile) {
                    document.getElementById('edit-nickname').value = userProfile.nickname;
                    document.getElementById('edit-bio').value = userProfile.bio || '';
                    document.getElementById('preview-ava').src = userProfile.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                }
            },
            
            closeModals: () => document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none'),
            
            toggleAuthMode: () => {
                isRegister = !isRegister;
                const btn = document.getElementById('btn-text');
                const link = document.getElementById('toggle-mode');
                const loginForm = document.getElementById('login-form');
                const regForm = document.getElementById('register-form');

                if (isRegister) {
                    loginForm.style.display = 'none';
                    regForm.style.display = 'block';
                    btn.innerText = 'Создать аккаунт';
                    link.innerText = 'Уже есть аккаунт? Войти';
                } else {
                    loginForm.style.display = 'block';
                    regForm.style.display = 'none';
                    btn.innerText = 'Войти';
                    link.innerText = 'Нет аккаунта? Создать';
                }
            },
            
            scrollToBottom: () => {
                const area = document.getElementById('msg-area');
                setTimeout(() => area.scrollTop = area.scrollHeight, 50);
            }
        };

        // --- IMAGE COMPRESSION UTILS ---
        const compressImage = (file, maxWidth = 800, quality = 0.7) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to compressed base64
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(dataUrl);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const app = {
            // --- AUTHENTICATION ---
            authenticate: async () => {
                if (isRegister) {
                    // REGISTRATION LOGIC
                    const email = document.getElementById('reg-email').value.trim();
                    const pass = document.getElementById('reg-password').value;
                    const username = document.getElementById('reg-username').value.toLowerCase().trim();
                    const nickname = document.getElementById('reg-nickname').value.trim();
                    
                    if (!email || !pass || !username || !nickname) return alert("Заполните все поля регистрации.");
                    if (username.length < 3) return alert("Username слишком короткий.");

                    try {
                        // Check if username taken
                        const snap = await get(child(ref(db), `usernames/${username}`));
                        if (snap.exists()) return alert("Этот Username уже занят. Придумайте другой.");

                        // Create Auth
                        const res = await createUserWithEmailAndPassword(auth, email, pass);
                        const uid = res.user.uid;

                        // Create DB Entry
                        const newUser = {
                            uid, username, nickname, 
                            bio: "Исследователь космоса",
                            avatar: "https://cdn-icons-png.flaticon.com/512/847/847969.png",
                            joined: Date.now()
                        };

                        await set(ref(db, `users/${uid}`), newUser);
                        await set(ref(db, `usernames/${username}`), uid);
                        
                        alert("Аккаунт создан!");
                    } catch (e) { alert("Ошибка регистрации: " + e.message); }

                } else {
                    // LOGIN LOGIC
                    const email = document.getElementById('login-email').value.trim();
                    const pass = document.getElementById('login-password').value;
                    
                    if(!email || !pass) return alert("Введите почту и пароль");

                    try {
                        await signInWithEmailAndPassword(auth, email, pass);
                    } catch (e) { alert("Ошибка входа: " + e.message); }
                }
            },

            logout: () => {
                if(confirm("Вы точно хотите выйти?")) signOut(auth);
            },

            // --- CHAT ENGINE ---
            selectChat: (id, name) => {
                if(currentChatId === id) return;
                currentChatId = id;
                
                document.getElementById('current-chat-name').innerText = name;
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('msg-area').innerHTML = '';
                
                document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
                const activeEl = document.getElementById(`chat-link-${id}`);
                if(activeEl) activeEl.classList.add('active');

                let msgRef = id === 'global' ? ref(db, 'messages') : ref(db, `chats/${id}/messages`);
                const q = query(msgRef, limitToLast(50));
                
                // Simple listener attach (for this demo scope)
                onChildAdded(q, (snap) => {
                    app.renderMessage(snap.val());
                });
            },

            renderMessage: (data) => {
                const area = document.getElementById('msg-area');
                const isMe = data.uid === currentUser.uid;
                
                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'msg-me' : 'msg-other'}`;
                
                let contentHtml = '';
                if (data.type === 'image') {
                    contentHtml = `<img src="${data.content}" class="msg-img" onclick="window.open(this.src)">`;
                } else {
                    const safeText = data.content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    contentHtml = `<div>${safeText}</div>`;
                }

                const showName = !isMe ? `<div style="font-size:0.75rem; color: var(--accent); font-weight:600; margin-bottom:2px;">${data.nickname}</div>` : '';
                const time = new Date(data.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

                div.innerHTML = `
                    ${!isMe ? `<div class="msg-info" style="margin-left: 5px;">${data.nickname}</div>` : ''}
                    <div class="msg-content">
                        ${contentHtml}
                        <div style="font-size: 0.65rem; opacity: 0.6; text-align: right; margin-top: 4px;">${time}</div>
                    </div>
                `;
                
                area.appendChild(div);
                ui.scrollToBottom();
            },

            // --- SENDING LOGIC ---
            sendText: () => {
                const input = document.getElementById('msg-input');
                const text = input.value.trim();
                if(!text) return;
                app.sendMessageData(text, 'text');
                input.value = '';
                input.focus();
            },

            uploadAndSend: async (file) => {
                if(!file) return;
                
                // New Logic: Compress before sending
                try {
                    const compressedBase64 = await compressImage(file);
                    app.sendMessageData(compressedBase64, 'image');
                } catch (err) {
                    alert("Ошибка обработки фото: " + err);
                }
            },

            sendMessageData: (content, type) => {
                let path = currentChatId === 'global' ? 'messages' : `chats/${currentChatId}/messages`;
                push(ref(db, path), {
                    uid: currentUser.uid,
                    nickname: userProfile.nickname,
                    avatar: userProfile.avatar,
                    content: content,
                    type: type,
                    timestamp: Date.now()
                });
            },

            // --- PROFILE & CONTACTS ---
            updateAvatar: async (file) => {
                if(!file) return;
                try {
                    const compressed = await compressImage(file, 300, 0.6); // Smaller for avatar
                    document.getElementById('preview-ava').src = compressed;
                    
                    await update(ref(db, `users/${currentUser.uid}`), { avatar: compressed });
                    userProfile.avatar = compressed;
                    document.getElementById('my-ava').src = compressed;
                } catch(err) { console.error(err); }
            },

            saveProfile: async () => {
                const nick = document.getElementById('edit-nickname').value.trim();
                const bio = document.getElementById('edit-bio').value.trim();
                if(nick) {
                    await update(ref(db, `users/${currentUser.uid}`), { nickname: nick, bio: bio });
                    userProfile.nickname = nick;
                    userProfile.bio = bio;
                    document.getElementById('my-name').innerText = nick;
                    document.getElementById('my-bio').innerText = bio || 'Настройки';
                    ui.closeModals();
                }
            },

            addContact: async () => {
                const username = document.getElementById('search-username').value.toLowerCase().trim();
                if(!username) return;
                
                const snap = await get(child(ref(db), `usernames/${username}`));
                if(!snap.exists()) return alert("Пользователь не найден");
                
                const targetUid = snap.val();
                if(targetUid === currentUser.uid) return alert("Нельзя добавить самого себя");

                const chatId = [currentUser.uid, targetUid].sort().join('_');
                
                const userSnap = await get(child(ref(db), `users/${targetUid}`));
                const targetUser = userSnap.val();

                const updates = {};
                updates[`users/${currentUser.uid}/chats/${chatId}`] = { 
                    type: 'private', name: targetUser.nickname, id: chatId, avatar: targetUser.avatar 
                };
                updates[`users/${targetUid}/chats/${chatId}`] = { 
                    type: 'private', name: userProfile.nickname, id: chatId, avatar: userProfile.avatar 
                };
                
                await update(ref(db), updates);
                ui.closeModals();
            },

            createGroup: async () => {
                const name = document.getElementById('new-group-name').value.trim();
                if(!name) return;
                
                const groupId = push(ref(db, 'chats')).key;
                const updates = {};
                
                updates[`chats/${groupId}/metadata`] = { name: name, admin: currentUser.uid };
                updates[`users/${currentUser.uid}/chats/${groupId}`] = { 
                    type: 'group', name: name, id: groupId, 
                    avatar: "https://cdn-icons-png.flaticon.com/512/1256/1256650.png"
                };
                
                await update(ref(db), updates);
                ui.closeModals();
            },

            loadChatsList: () => {
                const list = document.getElementById('contacts-list');
                
                onValue(ref(db, `users/${currentUser.uid}/chats`), (snap) => {
                    list.innerHTML = `
                        <div class="contact-item ${currentChatId === 'global' ? 'active' : ''}" 
                             id="chat-link-global"
                             onclick="app.selectChat('global', 'Общий Чат')">
                            <img src="https://cdn-icons-png.flaticon.com/512/921/921490.png" class="c-avatar-sm" style="background: #2d2f42; padding: 5px;">
                            <div class="c-info">
                                <div class="c-name">Общий Чат</div>
                                <div class="c-last">Весь мир тут</div>
                            </div>
                        </div>
                    `;

                    if(snap.exists()) {
                        snap.forEach(child => {
                            const chat = child.val();
                            const div = document.createElement('div');
                            div.className = `contact-item ${currentChatId === chat.id ? 'active' : ''}`;
                            div.id = `chat-link-${chat.id}`;
                            div.onclick = () => app.selectChat(chat.id, chat.name);
                            
                            div.innerHTML = `
                                <img src="${chat.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="c-avatar-sm">
                                <div class="c-info">
                                    <div class="c-name">${chat.name}</div>
                                    <div class="c-last">${chat.type === 'group' ? 'Группа' : 'Личное'}</div>
                                </div>
                            `;
                            list.appendChild(div);
                        });
                    }
                });
            }
        };

        // --- APP INITIALIZATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Logged In
                currentUser = user;
                const snap = await get(child(ref(db), `users/${user.uid}`));
                userProfile = snap.val();

                if(!userProfile) {
                    signOut(auth);
                    return;
                }

                document.getElementById('my-name').innerText = userProfile.nickname;
                document.getElementById('my-bio').innerText = userProfile.bio || "Статус не установлен";
                document.getElementById('my-ava').src = userProfile.avatar || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

                document.getElementById('auth-layer').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('auth-layer').style.display = 'none';
                    document.getElementById('app-layer').style.display = 'block';
                    setTimeout(() => document.getElementById('app-layer').style.opacity = 1, 50);
                }, 400);

                app.loadChatsList();
                app.selectChat('global', 'Общий Чат');

            } else {
                // Logged Out
                document.getElementById('app-layer').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('app-layer').style.display = 'none';
                    document.getElementById('auth-layer').style.display = 'flex';
                    document.getElementById('auth-layer').style.opacity = 1;
                }, 500);
            }
        });

        document.getElementById('msg-input').addEventListener('keypress', (e) => { 
            if(e.key === 'Enter') app.sendText(); 
        });

        window.app = app;
        window.ui = ui;
    </script>
</body>
</html>

